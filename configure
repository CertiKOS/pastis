#!/bin/sh

findlib() {
	lib=$1
	arg=$2
	for p in / /usr /usr/local $arg
	do
		if test -d $p/lib &&
		   find $p/lib -maxdepth 1 -name lib$lib\* |
		     grep '$' > /dev/null
		then
			echo $p
			return
		fi
	done
	echo "✗ could not find library $lib" 1>&2
}

if test -f config.mk
then
	# Reload last configuration
	. ./config.mk
fi

usage() {
	cat << EOM
./configure [OPTIONS]

	--prefix PATH      The installation prefix path
	--prefix=PATH
	--gmp PATH         The directory containing the GMP library
	--mpfr PATH        The directory containing the MPFR library

	--llvm-config CMD  The name used to invoke llvm-config.
	--cxx CMD          The C++ compiler to use (must support C++11)
	--cc CMD           The C compiler to use (must support C99)

	--help             Display this help message
EOM
	exit 0
}

OUR_PREFIX=/usr
LLC=llvm-config
CXX=c++
CC=cc

while test $# -gt 0
do
	arg=$1
	shift
	case $arg in
	--prefix=*)
		OUR_PREFIX=${arg#*=}
		;;
	--prefix)
		test $# -gt 0 || usage
		OUR_PREFIX=$1
		shift
		;;
	--gmp)
		test $# -gt 0 || usage
		GMP_PREFIX=$(dirname $1)
		shift
		;;
	--mpfr)
		test $# -gt 0 || usage
		MPFR_PREFIX=$(dirname $1)
		shift
		;;
	--llvm-config)
		test $# -gt 0 || usage
		LLC=$1
		shift
		;;
	--cc)
		test $# -gt 0 || usage
		CC=$1
		shift
		;;
	--cxx)
		test $# -gt 0 || usage
		CXX=$1
		shift
		;;
	*)
		usage
		;;
	esac
done

if ! ( ocamlbuild -vnum; ) > /dev/null 2>&1
then
	echo "✗ ocamlbuild cannot be run" 1>&2
	exit 1
fi

if ! ( $LLC --version; ) > /dev/null 2>&1
then
	LLC=
	echo "✗ warning: llvm-config not found, llvm-reader will not be built"
fi

GMP_PREFIX=$(findlib gmp $GMP_PREFIX)
test -n "$GMP_PREFIX" || exit 1

MPFR_PREFIX=$(findlib mpfr $MPFR_PREFIX)
test -n "$MPFR_PREFIX" || exit 1

cat > config.mk << EOF
# Autogenerated by the configure script.
OUR_PREFIX=$OUR_PREFIX
GMP_PREFIX=$GMP_PREFIX
MPFR_PREFIX=$MPFR_PREFIX
CXX=$CXX
CC=$CC
LLC=$LLC
EOF

if test -z $LLC
then
	buildllvm=no
else
	buildllvm=yes
fi

cat << EOM
Configuration:

   Installation prefix: $OUR_PREFIX
   MPFR library in:     $MPFR_PREFIX/lib
   GMP library in:      $GMP_PREFIX/lib
   C++ compiler:        $CXX
   C compiler:          $CC
   Build llvm-reader:   $buildllvm

EOM
